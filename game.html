<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>index</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

        
    <style>
        body{
            overflow: hidden;
        }
        canvas{
            background-color: black;
            background:black;
            /* width:100vw;
            height:100vh; */
            position: fixed;
            z-index: 10;
            top:0;
            left:0
        }
    </style>
</head>


<body style="width:100%;">

<div style="width:100vw;height:100vh">


    <canvas id="game" >
    </canvas>
</div>


    <script type="module">
    import {Points_Object} from './Points_Object.js';
    import {Pixel_Drawer} from './Pixel_Drawer.js';
    import {Point_3_D}from './Point_3_D.js';
    import {Game_Object} from './Game_Object.js';



    window.points_object_2d_cube_multiline_string = ``
    window.points_object_2d_cube = new Points_Object(
`
xxx
x x
xxx
`
)

    


    window.points_object_3_d_cube_multiline_string = ``
    window.points_object_3_d_cube = new Points_Object(
`
x x
 x 
x x
-
 x 
x x
 x 
-
x x
 x 
x x
`
)



// window.pdrw = new Pixel_Drawer(canvas);

// pdrw.scale_x = 10;
// pdrw.scale_y = 10;
// pdrw.grid_offset_x = 0.1;
// pdrw.grid_offset_y = 0.1;

// var textarea = document.createElement("textarea");
//document.documentElement.append(textarea);

// textarea.value = 
// `
// xxx
// x x
// xxx
// `;
// textarea.cols = 5;
// textarea.rows = 5;

// textarea.addEventListener("change", function(event) {


//     update_drawing();
// });




// function update_drawing(){
//     pdrw.clear();



//     window.points_object_2d_cube_multiline_string = ``
//     window.points_object_2d_cube = new Points_Object(textarea.value)
    

//     var zoom = 2;
// window.fps = window.points_object_2d_cube.get_fractal_points(3);

// //fps = t_fps;
// for(var key in fps){

//     var point = fps[key];

//     // ctx.beginPath();
//     // ctx.rect(point.x*zoom, point.y*zoom, zoom, zoom);
//     // ctx.fill();
    
//     pdrw.add_pixel({x: point.x, y: point.y, hue: parseInt(Math.random() * 360), brightness: Math.random()})
    
//     //pdrw.add_pixel({x: point.x, y: point.y, hue: key%360, brightness: 1})

// }

// // for(var i = 0; i< 10; i++){

// //     pdrw.add_pixel({x: i, y: i, hue: 360/10*i, brightness: 1})
// // }

// pdrw.render();
// }
// var counter = 0;

// window.setInterval(function(){
//     counter += 1;
//     //var t_fps = window.points_object_2d_cube.get_transformed_points(fps, 1,Math.sin(counter)*0,Math.sin(counter)*0.2,1);
//     var t_fps_scaled_questionmark = window.points_object_2d_cube.get_transformed_points(Math.cos(counter*0.1)+1,0,0,Math.sin(counter*0.1)+1, fps);
//     var angle = -(counter *0.1) % Math.PI*2;
//     var t_fps_rotated_clockwise_questionmark = window.points_object_2d_cube.get_transformed_points(Math.cos(angle),-Math.sin(angle), Math.sin(angle), Math.cos(angle), fps);
//     var t_fps = t_fps_rotated_clockwise_questionmark
    
//     pdrw.clear()
    

//     //fps = t_fps;
// for(var key in t_fps){

// var point = t_fps[key];

// // ctx.beginPath();
// // ctx.rect(point.x*zoom, point.y*zoom, zoom, zoom);
// // ctx.fill();

// // pdrw.add_pixel({x: point.x, y: point.y, hue: parseInt(Math.random() * 360), brightness: Math.random()})
// var brightness = Math.random();
//         var hue = parseInt(Math.random() * 360)

// pdrw.add_pixel({x: point.x, y: point.y, hue: hue, brightness: brightness})

// }


//     pdrw.render();
    
// }, 100)

// update_drawing();

// window.setInterval(function(){
//     pdrw.clear_canvas()
//     for(var key in pdrw.pixels){
        
//         var pxl = pdrw.pixels[key];
        
//         // ctx.beginPath();
//         // ctx.rect(point.x*zoom, point.y*zoom, zoom, zoom);
//         // ctx.fill();
        
//         pxl.brightness = Math.random();
//         pxl.hue = parseInt(Math.random() * 360)
        
//     }
//     pdrw.render();
    
// }, 100)


// window.setInterval(function(){
//     pdrw.clear()

//     for(var key in objects_to_render){
//         var o = objects_to_render[key];
//         var hue = o.hue || 1;
//         var brightness = o.brightness || 1;
        
//         o.render_function();
        
//         o.calculate_point_3_d();
//         //detect collisions 

//         for(var key2 in objects_to_render){
//             var o2 = objects_to_render[key2]
//             if(o2 == o){
//                 continue;
//             }
//             console.log(o.position_point_3_d, o2.position_point_3_d);
//             if(
//                 (parseInt(o.position_point_3_d.x) == parseInt(o2.position_point_3_d.x))
//                 &&
//                 (parseInt(o.position_point_3_d.y) == parseInt(o2.position_point_3_d.y))
//             ){
//                 o.collision_function(o2);
//             }
//         }
//         pdrw.add_pixel({x: o.position_point_3_d.x, y: o.position_point_3_d.y, hue: hue, brightness: brightness})
        
//     }


//     pdrw.render();
    
// }, 100)

// document.onkeydown = checkKey;

// function checkKey(e) {

//     e = e || window.event;

//     if (e.keyCode == '38') {
//         // up arrow
//             snake.position_velocity_point_3_d = new Point_3_D(0,-1,0);
//     }
//     else if (e.keyCode == '40') {
//         // down arrow
//             snake.position_velocity_point_3_d = new Point_3_D(0,1,0);
//     }
//     else if (e.keyCode == '37') {
//        // left arrow
//            snake.position_velocity_point_3_d = new Point_3_D(-1,0,0);
//     }
//     else if (e.keyCode == '39') {
//        // right arrow
//            snake.position_velocity_point_3_d = new Point_3_D(1,0,0);
//     }
//     if(e.keyCode == 0 || e.keyCode == 32){

//         var shot = new Game_Object();
//         shot.hue = 100;
//         shot.position_point_3_d = {...snake.position_point_3_d}
//         shot.position_velocity_point_3_d = {...snake.position_velocity_point_3_d}
//         shot.position_acceleration_point_3_d = {...snake.position_velocity_point_3_d}
        
//         window.objects_to_render.push(shot)
//     }

// }




class Game {
  constructor(multiline_string){
      
    
    this.pixel_drawer = new Pixel_Drawer(document.querySelector("canvas#game"));
    var per_width = 10;
    
    var self = this;
    // window.onresize = function(){
        
    //     var width = window.innerWidth / per_width;
    //     var per_height = window.innerHeight / width;
    //     this.pixel_drawer.scale_x = per_width;
    //     this.pixel_drawer.scale_y = per_height;

    // }
        this.pixel_drawer.scale_x = 10;
        this.pixel_drawer.scale_y = 10;

    this.render_id = 0;
    this.fps = 60;
    this.render_delta_limit_ms = 1000/this.fps;
    this.render_delta_ms = 0;
    this.performance_now = performance.now();
    this.performance_then = performance.now();
    this.keydownsups = {};

    /**
     * used for detecting collisions
     * [
     *       if a array has two items a collision has occured
     *  [[x0] [x1, x1]] y 1  
     *  []
     *  [] 
     * ] */
    this.collision_array = [];
    this.collision_object = {};



    var game = this;

    // this.snake = new Game_Object();
    // this.snake.name = "snake";
    // this.snake.velocity = 0.1
    // this.snake.position_velocity_point_3_d = new Point_3_D( this.snake.velocity,0,0)
    // this.snake.limbs = []

    // this.snake.add_limb = function(){
    //     console.log("add_limb called");
    //     var limb = new Game_Object();
    //     limb.name = "limb"
    //     limb.hue = Math.random()*360;
    //     limb.position_point_3_d = Object.create(this.position_point_3_d);
    //     //Object.assign({}, this.position_point_3_d)// {...this.position_point_3_d}
    //     //limb.position_velocity_point_3_d = {...this.position_velocity_point_3_d}
    //     //limb.position_acceleration_point_3_d = {...this.position_velocity_point_3_d}
    //     this.limbs.push(limb)
    // }

    // this.snake.render_function = function(){

    //         if (game.keydownsups["keyCode_38"]) {
    //             // up arrow
    //                 this.position_velocity_point_3_d.x = 0
    //                 this.position_velocity_point_3_d.y = -this.velocity
    //                 this.position_velocity_point_3_d.z = 0
    //         }
    //         else if (game.keydownsups["keyCode_40"]) {
    //             // down arrow
    //             this.position_velocity_point_3_d.x = 0
    //                 this.position_velocity_point_3_d.y = this.velocity
    //                 this.position_velocity_point_3_d.z = 0

    //         }
    //         else if (game.keydownsups["keyCode_37"]) {
    //         // left arrow
    //         this.position_velocity_point_3_d.x = -this.velocity
    //                 this.position_velocity_point_3_d.y = this.velocity
    //                 this.position_velocity_point_3_d.z = 0
    //         }
    //         else if (game.keydownsups["keyCode_39"]) {
    //         // right arrow
    //         this.position_velocity_point_3_d.x = this.velocity
    //                 this.position_velocity_point_3_d.y = 0
    //                 this.position_velocity_point_3_d.z = 0
    //         }
    //         if(game.keydownsups["keyCode_65"]){

    //             this.velocity = 0.5
    //         }

    //         if(this._last_rendered_position_point_3_d.int_parsed_to_x_y_string() != this.position_point_3_d.int_parsed_to_x_y_string()){

    //             for(var key in this.limbs){
    //                 var index = this.limbs.length-1  - key;
    //                 var limb = this.limbs[index];
    //                 var limb_before = this.limbs[index-1]
    //                 if(!limb_before){
    //                     limb_before = this
    //                 }
    //                 if(limb_before == undefined){
    //                     debugger;
    //                 }
                    
    //                 limb.position_point_3_d = Object.create(limb_before.position_point_3_d);

    //                 // limb.position_point_3_d = {...limb_before.position_point_3_d}
    //             }
    //         }
    // }

    // /**
    //  * 
    //  **/
    // this.snake.collision_function = function(collision_sender, collision_receiver){

    //     if(collision_receiver.name == "food"){
    //         this.add_limb();
    //     }

    // }

    // this.food = new Game_Object();
    // this.food.position_point_3_d.x = 10;
    // this.food.position_point_3_d.y = 10;

    // this.food.hue = 150
    // this.food.name = "food";

    // this.food.collision_function = function(collision_sender, collision_receiver){
        
    //     this.position_point_3_d.x = parseInt(Math.random()*game.pixel_drawer.pixel_grid_width)
    //     this.position_point_3_d.y = parseInt(Math.random()*game.pixel_drawer.pixel_grid_height)
    // }


    this.spaceship = new Game_Object(`\n x \nxxx`);
    this.spaceship.hue = 243
    this.spaceship.name = "spaceship";
    this.spaceship.position_point_3_d.x = 10;
    this.spaceship.position_point_3_d.y = 23;
    this.spaceship.movement_velocity = 1;
    this.spaceship.weapons = [
        "straight",
        "circular",
        "sine"
    ], 
    this.spaceship.weapon_index = 0;

    this.spaceship.render_function = function(){

            if (game.keydownsups["keyCode_38"]) {
                // up arrow
                this.position_point_3_d.y -= this.movement_velocity;

                this.weapon_index = (this.weapon_index + 1) % this.weapons.length
                this.weapon = this.weapons[this.weapon_index]
                this.hue = 1 / this.weapons.length * this.weapon_index * 360;
            }
            else if (game.keydownsups["keyCode_40"]) {
                // down arrow
                this.position_point_3_d.y+=this.movement_velocity;
            }
            if (game.keydownsups["keyCode_37"]) {
                // left arrow
                this.position_point_3_d.x-=this.movement_velocity;
            }
            if (game.keydownsups["keyCode_39"]) {
                // right arrow
                this.position_point_3_d.x+=this.movement_velocity;
            }
            if (game.keydownsups["keyCode_32"]) {


                if(this.weapon == "straight"){
                    
                    var shot = new Game_Object();
                    // space bar
                    shot.hue = this.hue;
                    shot.name = "shot"
                    shot.position_point_3_d.x = this.points_object.relative_center_x + this.position_point_3_d.x;
                    shot.position_point_3_d.y = this.position_point_3_d.y;
                    shot.position_velocity_point_3_d.y = -1;

                shot.render_function = function(){
                    
                    //this.hue = parseInt(this.render_id % 360);
                    if(
                        this.position_point_3_d.x < 0 ||
                        this.position_point_3_d.y < 0 ||
                        this.position_point_3_d.x >= game.pixel_drawer.pixel_grid_width ||
                        this.position_point_3_d.y >= game.pixel_drawer.pixel_grid_height 
                    ){
                        this.destroy();
                    }
                    
                }

                }
                if(this.weapon == "circular"){
                    var shot = new Game_Object();
                    // space bar
                    shot.hue = this.hue;
                    shot.name = "shot"
                    shot.position_point_3_d.x = this.points_object.relative_center_x + this.position_point_3_d.x;
                    shot.position_point_3_d.y = this.position_point_3_d.y;
                    shot.position_velocity_point_3_d.y = -1;

                shot.render_function = function(){
                    
                    //this.hue = parseInt(this.render_id % 360);
                    if(
                        this.position_point_3_d.x < 0 ||
                        this.position_point_3_d.y < 0 ||
                        this.position_point_3_d.x >= game.pixel_drawer.pixel_grid_width ||
                        this.position_point_3_d.y >= game.pixel_drawer.pixel_grid_height 
                    ){
                        this.destroy();
                    }
                    
                }

                    var shot2 = new Game_Object();
                    // space bar
                    shot2.hue = this.hue;
                    shot2.name = "shot"
                    shot2.position_point_3_d.x = this.points_object.relative_center_x + this.position_point_3_d.x;
                    shot2.position_point_3_d.y = this.position_point_3_d.y;
                    shot2.position_velocity_point_3_d.y = -1;
                    shot2.position_velocity_point_3_d.x = -0.5;
                    shot2.render_function = shot.render_function;

                    

                    var shot3 = new Game_Object();
                    // space bar
                    shot3.hue = this.hue;
                    shot3.name = "shot"
                    shot3.position_point_3_d.x = this.points_object.relative_center_x + this.position_point_3_d.x;
                    shot3.position_point_3_d.y = this.position_point_3_d.y;
                    shot3.position_velocity_point_3_d.y = -1;
                    shot3.position_velocity_point_3_d.x = 0.5;
                    shot3.render_function = shot.render_function;

                    

                }
                if(this.weapon == "sine"){
                    
                    var shot = new Game_Object();
                    // space bar
                    shot.hue = this.hue;
                    shot.name = "shot"
                    shot.position_point_3_d.x = this.points_object.relative_center_x + this.position_point_3_d.x;
                    shot.position_point_3_d.y = this.position_point_3_d.y;
                    shot.position_velocity_point_3_d.y = -1;

                shot.render_function = function(){
                    
                    //this.position_point_3_d.x = this.position_point_3_d.x + Math.sin((this.render_id)*0.3)*2;
                    //this.position_point_3_d.x = this.position_point_3_d.x + Math.sin(Math.PI + this.render_id *0.5)*1 - 1;
                    this.position_point_3_d.x = this.position_point_3_d.x + Math.sin( Math.PI * 2 / 4*2.8  + this.render_id *0.5)*2;

                    //this.hue = parseInt(this.render_id % 360);
                    if(
                        this.position_point_3_d.x < 0 ||
                        this.position_point_3_d.y < 0 ||
                        this.position_point_3_d.x >= game.pixel_drawer.pixel_grid_width ||
                        this.position_point_3_d.y >= game.pixel_drawer.pixel_grid_height 
                    ){
                        this.destroy();
                    }
                    
                }

                }


            }

    }
    
    this.spawn_enemy = function(){
        this.enemy = new Game_Object(`\nxxx\n x`);
        this.enemy.position_point_3_d.x = Math.random()*20
        this.enemy.position_point_3_d.y = Math.random()*10
        this.enemy.next_random_render_id = Math.random()*30;

        this.enemy.hue = 30;
        this.enemy.life = 1;
        this.enemy.hits = 0;
        this.enemy.name = "enemy"
        this.enemy.explosion_function = function(){}
        
        this.enemy.render_function = function(){
            
            this.brightness = this.life;
            
            this.position_point_3_d.x+= Math.sin((this.render_id)*0.05)*1;

            
            if(this.render_id >= this.next_random_render_id){
                this.next_random_render_id =  this.render_id + Math.random()*30; 
                this.shoot();
            }
            this.explosion_function();
        }
        this.enemy.shoot = function(){

            var shot = new Game_Object();
            shot.hue = this.hue;
            shot.name = "shot_enemy"
            shot.position_point_3_d.x = this.points_object.relative_center_x + this.position_point_3_d.x;
            shot.position_point_3_d.y = this.position_point_3_d.y;
            shot.position_velocity_point_3_d.y = 1;
            shot.render_function = function(){
                if(
                    this.position_point_3_d.x < 0 ||
                    this.position_point_3_d.y < 0 ||
                    this.position_point_3_d.x >= game.pixel_drawer.pixel_grid_width ||
                    this.position_point_3_d.y >= game.pixel_drawer.pixel_grid_height 
                ){
                    this.destroy();
                }
            }
        }

        this.enemy.collision_function = function(other_object){

            if(other_object.name == "shot"){
                this.hits += 1;
                this.life = 1 / this.hits;

            }

            if(this.hits > 4){
                this.render_id_limit =  this.render_id + 50;
                this.explosion_function = function(){
                    this.brightness = Math.sin(this.render_id) + 1;
                    var explosion_factor = (this.render_id / this.render_id_limit)*1;
                    this.points_object.points = this.points_object.get_transformed_points(1.05,0,0,1.05)
                }
                this.collision_function = function(){}
            }
        }
        

    }

    this.spawn_enemy();

    
    var self = this;

    document.onkeydown = function(){
        var e = e || window.event;

        self.keymap_keydownsups(e, self)
    }
    document.onkeyup = function(){
        var e = e || window.event;

        self.keymap_keydownsups(e, self)
    }
      console.log(this + "was constructed");
    }
    
    keymap_keydownsups(e, self){
        if(e.type == "keydown"){
            self.keydownsups["keyCode_"+e.keyCode] = true;
        }
        if(e.type == "keyup"){
            self.keydownsups["keyCode_"+e.keyCode] = false;
        }
    }

    render(){
        this.pixel_drawer.clear()
        this.collision_array = []
        this.collision_object = {}

        //console.log(this.render_id)

        for(var key in Game_Object.instances){
            var o = Game_Object.instances[key];
            var hue = o.hue || 1;
            var brightness = o.brightness || 1;
            o.render_id ++; 
            if(o.render_id_limit > 0 && o.render_id >= o.render_id_limit){
                o.destroy();
                //delete o;
                continue;
            }

            //must be called before render_function
            o.calculate_point_3_d();

            o.render_function();

            //detect collisions 
            // detect collisions only if position of object has changed 
            // this will prevent the collision firing multiple times although the position of objects would not have changed
            // when velocity < 1 zb velocity = 0.1
            // since subpixel rendering not possible

            // if(o._last_rendered_position_point_3_d.int_parsed_to_x_y_string() != o.position_point_3_d.int_parsed_to_x_y_string()){
                
            //     for(var key2 in Game_Object.instances){
            //         var o2 = Game_Object.instances[key2]
            //         if(o2 == o){
            //             continue;
            //         }

            //         for(var key3 in o.points_object.points){
            //             var o_point = o.points_object.points[key3];
                    
            //             for(var key4 in o2.points_object.points){
            //                 var o2_point = o.points_object.points[key4];
                            
            //                 if( 
            //                     parseInt(o.position_point_3_d.x + o_point.position_point_3_d.x) == parseInt(o2.position_point_3_d.x + o2_point.position_point_3_d.x)
            //                     && 
            //                     parseInt(o.position_point_3_d.y + o_point.position_point_3_d.y) == parseInt(o2.position_point_3_d.y + o2_point.position_point_3_d.y)
            //                     //o_point.position_point_3_d.int_parsed_to_x_y_string() == o2_point.position_point_3_d.int_parsed_to_x_y_string() not working since point_
            //                     ){
            //                     var collision_sender = o;
            //                     var collision_receiver = o2;
            //                     o.collision_function(collision_sender, collision_receiver);
            //                     o2.collision_function(collision_sender, collision_receiver); 
            //                 }
                            
            //             }

            //         }

            //         // old check only position of objects
            //         // if( o.position_point_3_d.int_parsed_to_x_y_string() == o2.position_point_3_d.int_parsed_to_x_y_string()){
            //         //     var collision_sender = o;
            //         //     var collision_receiver = o2;
            //         //     o.collision_function(collision_sender, collision_receiver);
            //         //     o2.collision_function(collision_sender, collision_receiver);
            //         // }
            //     }

            // }

            for(var key in o.points_object.points){
                var point = o.points_object.points[key];
                var x = parseInt(o.position_point_3_d.x + point.x);
                var y = parseInt(o.position_point_3_d.y + point.y);
                
                if(this.collision_object[x+"|"+y] == undefined){
                    this.collision_object[x+"|"+y] = [];
                } 
                this.collision_object[x+"|"+y].push(o)
                console.log(this.collision_object[x+"|"+y].length);
                
                if(this.collision_object[x+"|"+y].length>1){
                    for(var key5 in this.collision_object[x+"|"+y]){
                        var co = this.collision_object[x+"|"+y][key5];
                        if(co == o){
                            continue;
                        }
                        o.collision_function(co);
                        co.collision_function(o);

                    }

                }

                this.pixel_drawer.add_pixel({x:x , y: y, hue: hue, brightness: brightness})
            }


        }

        this.pixel_drawer.render();
    }

    render_loop(){

        //console.log("render_loop was called");

        this.performance_now = performance.now();
        this.render_delta_ms = Math.abs(this.performance_now - this.performance_then)

        if(this.render_delta_ms > this.render_delta_limit_ms){
            
            this.render();
            
            this.performance_then = this.performance_now;
        }

        this.render_id = requestAnimationFrame(this.render_loop.bind(this));
    }
    /**
     * honk honk 
     * performs a so called vector addition
     * @param {string} type 
     */
    start_rendering(type){
        this.render_id = requestAnimationFrame(this.render_loop.bind(this));

    }
    stop_rendering(type){
        cancelAnimationFrame(this.render_id)
    }


}

window.g = new Game();
g.start_rendering();


    </script>



</body>
</html>